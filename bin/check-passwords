#!/bin/zsh

{
  for file in ~/.password-store/**/*(.); do
    gpg --decrypt "$file" 2>/dev/null | head -n 1;
  done
} | python3 <(/bin/cat <<'EOF'
import hashlib
import sys
import urllib.request

def check_password(password):
    digest = hashlib.sha1(password.encode()).hexdigest().upper()
    prefix, suffix = digest[:5], digest[5:]

    request = urllib.request.Request(
        "https://api.pwnedpasswords.com/range/{}".format(prefix),
        headers={"User-Agent": "check-passwords"},
    )

    with urllib.request.urlopen(request) as response:
        for line in response.readlines():
            line = line.decode().strip()
            if line.split(":")[0] == suffix:
                print("Compromised: {}".format(password))
                break

for password in sys.stdin:
    check_password(password.strip())
EOF
)
